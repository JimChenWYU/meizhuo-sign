<template>
    <form novalidate @submit.stop.prevent="submit()" class="content">
	  <div class="field-group">
		<md-input-container :class="{ 'md-input-invalid' : errors.department }">
		  <label>部门</label>
		  <md-select
			name="department"
			id="department"
			v-model="department"
			required>
			<md-option v-for="dept of l_department" :value="dept.value">{{dept.name}}</md-option>

		  </md-select>
		  <span class="md-error"
				v-for="(error, index) of errors.department"
				v-if="index === 0">{{error}}</span>
		</md-input-container>
		&nbsp;&nbsp;
		<md-input-container :class="{ 'md-input-invalid' : errors.tab }">
		  <label>组数</label>
		  <md-select
			name="tab"
			id="tab"
			v-model="tab"
			required>
			<md-option v-for="tab of l_tab" :value="tab.value">{{tab.name}}</md-option>
		  </md-select>
		  <span class="md-error"
				v-for="(error, index) of errors.tab"
				v-if="index === 0">{{error}}</span>
		</md-input-container>
	  </div>

	  <md-layout md-column>
            <md-button class="md-raised md-primary" type="submit" md-fab-bottom-center>确定</md-button>
        </md-layout>

	  <md-spinner
		  :md-size="100"
		  :md-stroke="1.5"
		  md-indeterminate
		  v-show="isLoading"
		  class="spinner">
		</md-spinner>

	  <md-dialog-alert
		  :md-content="alert.content"
		  :md-ok-text="alert.ok"
		  ref="login-tip">
        </md-dialog-alert>
    </form>
</template>

<style lang="sass" scoped>
  .content {
	padding-top: 50px;
	text-align: center;
  }
  .field-group {
	display: flex;
  }
  .spinner {
	position: absolute;
	margin: auto;
	left: 0;
	right: 0;
  }
</style>

<script type="es6">
    import { mapActions } from 'vuex'
    export default{

	  created () {
		this.setHeader({
		  title: '管理后台登录',
		  type: 'admin.login'
		})
	  },

	  data(){
		return{
		  alert: {
			content: 'tip',
			ok: '确定'
		  },
		  l_department: [
			{ name: '安卓组', value: 'android' },
			{ name: 'Web组', value: 'web' },
			{ name: '美工组', value: 'design' },
			{ name: '营销策划', value: 'marking' },
		  ],
		  l_tab: [
			{ name: '第一组', value: 1 },
			{ name: '第二组', value: 2 },
			{ name: '第三组', value: 3 },
		  ],
		  department: '',
		  tab: '',
		  isLoading: false
		}
	  },

	  vuerify: {
		department: [ 'required' ],
		tab: [ 'required' ]
	  },

	  computed: {
		adminData () {
		  return {
			department: this.department,
			tab: this.tab
		  }
		},

		errors () {
		  return this.$vuerify.$errors
		},

		validate() {
		  let isPass = this.$vuerify.check()
		  if (! isPass) {
			  // console.log(this.$vuerify)
		  }
		  return isPass
		}
	  },

	  methods: {

		...mapActions(['setHeader']),

		setLoading () {
		  this.isLoading = !this.isLoading
		},

		submit() {
		  if (this.validate) {
			this.setLoading()
			this.login()
		  }
		},

		login () {
		  this.$http.post(this.$env.adminInterviewLogin, this.adminData)
			.then(response => {
			  let res = response.data
			  //console.log(res)
			  this.setLoading()
			  this.$router.replace(res.data.redirect)
			})
			.catch(error => {
			  this.setLoading()
			  this.openDialog('login-tip', error.msg || error)
			})
		},

		openDialog(ref, msg) {
		  this.alert.content = msg
		  this.$refs[ref].open()
		},
		closeDialog(ref) {
		  this.$refs[ref].close()
		}
	  }
    }
</script>
